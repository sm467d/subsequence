<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>subsequence</title>
  <link rel="icon" type="image/svg+xml" href="branding/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0a0a0a;
      color: #ffffff;
      font-family: 'Archivo', sans-serif;
      min-height: 100vh;
      user-select: none;
    }

    header {
      display: flex;
      align-items: center;
      padding: 16px 28px;
      gap: 32px;
      border-bottom: 1px solid #1a1a1a;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      cursor: pointer;
    }

    .logo-text {
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.04em;
      color: #ffffff;
      opacity: 0.9;
    }

    .logo-icon {
      width: 20px;
      height: 20px;
      opacity: 0.85;
    }

    nav {
      display: flex;
      gap: 6px;
    }

    nav a {
      color: #555555;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.03em;
      padding: 8px 20px;
      cursor: pointer;
    }

    nav a:hover {
      color: #999999;
    }

    nav a.active {
      color: #ffffff;
      border-bottom: 1px solid #ffffff;
    }

    .nav-right {
      margin-left: auto;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 28px;
    }

    /* auth */
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 25vh;
      width: 260px;
    }

    .auth-title {
      font-size: 14px;
      color: #888888;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }

    .auth-input {
      background: #141414;
      border: 1px solid #333333;
      color: #ffffff;
      font-family: inherit;
      font-size: 14px;
      padding: 10px 14px;
      outline: none;
      letter-spacing: 0.03em;
    }

    .auth-input:focus {
      border-color: #ffffff;
    }

    .auth-input::placeholder {
      color: #444444;
    }

    .auth-submit {
      background: none;
      border: 1px solid #333333;
      color: #888888;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      padding: 10px 24px;
      cursor: pointer;
      letter-spacing: 0.03em;
    }

    .auth-submit:hover {
      color: #ffffff;
      border-color: #ffffff;
    }

    .auth-error {
      font-size: 12px;
      color: #ef4444;
      letter-spacing: 0.03em;
    }

    .auth-toggle {
      font-size: 12px;
      color: #555555;
      cursor: pointer;
      letter-spacing: 0.03em;
    }

    .auth-toggle:hover {
      color: #999999;
    }

    /* mode selector */
    .mode-select {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-top: 25vh;
    }

    .mode-row {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      min-height: 42px;
    }

    .mode-row-label {
      font-size: 11px;
      color: #333333;
      letter-spacing: 0.06em;
      width: 60px;
      text-align: right;
      margin-right: 8px;
    }

    .mode-row-label.hidden {
      visibility: hidden;
    }

    .mode-btn {
      background: none;
      border: 1px solid #333333;
      color: #888888;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      padding: 10px 24px;
      cursor: pointer;
      letter-spacing: 0.03em;
    }

    .mode-btn.hidden {
      visibility: hidden;
    }

    .mode-btn:hover {
      color: #ffffff;
      border-color: #ffffff;
    }

    .mode-btn.selected {
      color: #ffffff;
      border-color: #ffffff;
    }

    /* hud */
    .hud {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: min(55vw, 55vh);
      margin-bottom: 12px;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.05em;
      color: #555555;
    }

    .hud-score { color: #ffffff; }
    .hud-timer { color: #ffffff; }
    .hud-mode { color: #555555; }

    /* grid */
    .grid {
      display: grid;
      width: min(55vw, 55vh);
      height: min(55vw, 55vh);
      cursor: crosshair;
    }

    .cell {
      background: #141414;
      border: 1px solid #0a0a0a;
      cursor: crosshair;
    }

    .cell.target {
      background: #ffffff;
    }

    /* results */
    .results {
      margin-top: 60px;
      text-align: center;
    }

    .results-score {
      font-size: 48px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .results-label {
      font-size: 13px;
      color: #555555;
      letter-spacing: 0.05em;
      margin-top: 4px;
    }

    .results-stats {
      display: flex;
      gap: 32px;
      justify-content: center;
      margin-top: 24px;
      font-size: 14px;
      color: #888888;
    }

    .results-stats span {
      color: #ffffff;
    }

    .results-new-best {
      font-size: 12px;
      color: #22c55e;
      letter-spacing: 0.05em;
      margin-top: 8px;
    }

    .again-btn {
      background: none;
      border: 1px solid #333333;
      color: #888888;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      padding: 8px 24px;
      cursor: pointer;
      letter-spacing: 0.03em;
      margin-top: 32px;
    }

    .again-btn:hover {
      color: #ffffff;
      border-color: #ffffff;
    }

    /* history */
    .history {
      margin-top: 40px;
      width: 100%;
      max-width: 400px;
    }

    .history-title {
      font-size: 12px;
      color: #555555;
      letter-spacing: 0.06em;
      margin-bottom: 12px;
    }

    .history-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px solid #141414;
    }

    .history-rank {
      color: #333333;
      width: 24px;
    }

    .history-score {
      color: #ffffff;
      flex: 1;
    }

    .history-acc {
      color: #555555;
      width: 60px;
      text-align: right;
    }

    .history-date {
      color: #333333;
      width: 80px;
      text-align: right;
    }

    /* settings */
    .settings {
      width: 100%;
      max-width: 400px;
      margin-top: 48px;
    }

    .settings-section {
      margin-bottom: 32px;
    }

    .settings-label {
      font-size: 13px;
      color: #555555;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }

    .sound-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sound-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .sound-row:hover {
      border-color: #333333;
    }

    .sound-row.selected {
      border-color: #ffffff;
    }

    .sound-name {
      font-size: 14px;
      color: #888888;
      flex: 1;
    }

    .sound-row.selected .sound-name {
      color: #ffffff;
    }

    .sound-test {
      background: none;
      border: 1px solid #333333;
      color: #555555;
      font-family: inherit;
      font-size: 11px;
      padding: 4px 12px;
      cursor: pointer;
      letter-spacing: 0.03em;
    }

    .sound-test:hover {
      color: #ffffff;
      border-color: #ffffff;
    }
  </style>
</head>
<body>
  <header>
    <a href="/" class="logo">
      <img src="branding/logo.svg" alt="subsequence" class="logo-icon">
      <span class="logo-text">subsequence</span>
    </a>
    <nav>
      <a href="#grid" data-tab="grid" class="active">grid</a>
      <a href="#edit" data-tab="edit">edit</a>
      <a href="#settings" data-tab="settings" class="nav-right">settings</a>
    </nav>
  </header>
  <main id="content"></main>

  <script>
    // supabase
    var sb = supabase.createClient(
      'https://ebbciupfgmicgxpzxcnv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViYmNpdXBmZ21pY2d4cHp4Y252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTYxMjAsImV4cCI6MjA4NzI5MjEyMH0.j6BJb_BeaPwZhdV2Fqpt1dFawhxvB4BbzMBBRUaaTdY'
    );

    var currentUser = null;
    var content = document.getElementById('content');
    var gameTimer = null;
    var gameState = null;

    // selected mode/duration/grid — persisted
    var selectedMode = localStorage.getItem('subsequence_mode') || 'time';
    var selectedDuration = parseInt(localStorage.getItem('subsequence_duration')) || 30;
    var selectedGrid = parseInt(localStorage.getItem('subsequence_grid')) || 9;

    // sounds
    var sounds = [
      { id: 'none', name: 'none' },
      { id: 'click_1', name: 'click 1', file: 'sounds/click_1.wav' },
      { id: 'click_2', name: 'click 2', file: 'sounds/click_2.wav' },
      { id: 'click_3', name: 'click 3', file: 'sounds/click_3.wav' },
      { id: 'click_4', name: 'click 4', file: 'sounds/click_4.wav' },
      { id: 'click_5', name: 'click 5', file: 'sounds/click_5.wav' },
      { id: 'click_6', name: 'click 6', file: 'sounds/click_6.wav' }
    ];

    var selectedSound = 'click_1';
    var audioCache = {};

    function preloadSounds() {
      sounds.forEach(function(s) {
        if (s.file) {
          var a = new Audio(s.file);
          a.preload = 'auto';
          audioCache[s.id] = a;
        }
      });
    }
    preloadSounds();

    function playHitSound() {
      if (selectedSound === 'none') return;
      var cached = audioCache[selectedSound];
      if (!cached) return;
      var clone = cached.cloneNode();
      clone.volume = 1;
      clone.play();
    }

    async function loadSoundSetting() {
      if (!currentUser) return;
      var { data } = await sb.from('user_settings').select('sound').eq('user_id', currentUser.id).single();
      if (data) {
        selectedSound = data.sound;
      } else {
        // no settings row yet — create one
        await sb.from('user_settings').insert({ user_id: currentUser.id, sound: 'click_1' });
      }
    }

    async function saveSoundSetting(id) {
      selectedSound = id;
      if (!currentUser) return;
      await sb.from('user_settings').upsert({ user_id: currentUser.id, sound: id, updated_at: new Date().toISOString() });
    }

    // auth
    async function initAuth() {
      var { data } = await sb.auth.getSession();
      if (data && data.session) {
        currentUser = data.session.user;
        await loadSoundSetting();
        onAuthReady();
      } else {
        showAuth('sign up');
      }
    }

    function showAuth(mode) {
      content.innerHTML = '';
      var form = document.createElement('div');
      form.className = 'auth-form';

      var title = document.createElement('div');
      title.className = 'auth-title';
      title.textContent = mode;
      form.appendChild(title);

      var usernameInput = document.createElement('input');
      usernameInput.className = 'auth-input';
      usernameInput.type = 'text';
      usernameInput.placeholder = 'username';
      usernameInput.autocomplete = 'username';
      form.appendChild(usernameInput);

      var passInput = document.createElement('input');
      passInput.className = 'auth-input';
      passInput.type = 'password';
      passInput.placeholder = 'password';
      passInput.autocomplete = mode === 'sign up' ? 'new-password' : 'current-password';
      form.appendChild(passInput);

      var confirmInput = null;
      if (mode === 'sign up') {
        confirmInput = document.createElement('input');
        confirmInput.className = 'auth-input';
        confirmInput.type = 'password';
        confirmInput.placeholder = 'confirm password';
        confirmInput.autocomplete = 'new-password';
        form.appendChild(confirmInput);
      }

      var errorEl = document.createElement('div');
      errorEl.className = 'auth-error';
      form.appendChild(errorEl);

      var submit = document.createElement('button');
      submit.className = 'auth-submit';
      submit.textContent = mode;
      form.appendChild(submit);

      var toggle = document.createElement('div');
      toggle.className = 'auth-toggle';
      toggle.textContent = mode === 'sign up' ? 'already have an account? sign in' : 'need an account? sign up';
      toggle.addEventListener('click', function() {
        showAuth(mode === 'sign up' ? 'sign in' : 'sign up');
      });
      form.appendChild(toggle);

      async function doAuth() {
        var username = usernameInput.value.trim().toLowerCase();
        var password = passInput.value;
        errorEl.textContent = '';

        if (!username) { errorEl.textContent = 'enter a username'; return; }
        if (password.length < 6) { errorEl.textContent = 'password must be at least 6 characters'; return; }

        var email = username + '@subsequence.gg';

        if (mode === 'sign up') {
          if (password !== confirmInput.value) { errorEl.textContent = 'passwords do not match'; return; }
          var { data, error } = await sb.auth.signUp({ email: email, password: password });
          if (error) { errorEl.textContent = error.message; return; }
          if (data && data.session) {
            currentUser = data.session.user;
            // create default settings (session must be active for RLS)
            var { error: settingsErr } = await sb.from('user_settings').insert({ user_id: currentUser.id, sound: 'click_1' });
            if (settingsErr) console.error('settings insert error:', settingsErr);
            await loadSoundSetting();
            onAuthReady();
          } else if (data && data.user) {
            // fallback if session not returned but user exists (auto-sign-in)
            currentUser = data.user;
            onAuthReady();
          }
        } else {
          var { data, error } = await sb.auth.signInWithPassword({ email: email, password: password });
          if (error) { errorEl.textContent = error.message; return; }
          if (data && data.user) {
            currentUser = data.user;
            await loadSoundSetting();
            onAuthReady();
          }
        }
      }

      submit.addEventListener('click', doAuth);
      form.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') doAuth();
      });

      content.appendChild(form);
      usernameInput.focus();
    }

    function onAuthReady() {
      var hash = window.location.hash.slice(1) || 'grid';
      showTab(hash);
    }

    // nav
    document.querySelectorAll('nav a').forEach(function(a) {
      a.addEventListener('click', function() {
        if (!currentUser) return;
        document.querySelector('nav a.active').classList.remove('active');
        this.classList.add('active');
        showTab(this.dataset.tab);
      });
    });

    function showTab(tab) {
      if (gameTimer) { clearInterval(gameTimer); gameTimer = null; }
      if (tab === 'grid') showModeSelect();
      else if (tab === 'settings') showSettings();
      else content.innerHTML = '';
    }

    // mode select
    function showModeSelect() {
      content.innerHTML = '';
      var wrap = document.createElement('div');
      wrap.className = 'mode-select';

      // row 1: mode
      var row1 = document.createElement('div');
      row1.className = 'mode-row';
      var label1 = document.createElement('div');
      label1.className = 'mode-row-label';
      label1.textContent = 'mode';
      row1.appendChild(label1);

      var timeRow; // reference for toggling

      ['time', 'perfection'].forEach(function(m) {
        var btn = document.createElement('button');
        btn.className = 'mode-btn' + (m === selectedMode ? ' selected' : '');
        btn.textContent = m;
        btn.addEventListener('mousedown', function() {
          selectedMode = m;
          localStorage.setItem('subsequence_mode', m);
          row1.querySelectorAll('.mode-btn').forEach(function(b) { b.classList.remove('selected'); });
          btn.classList.add('selected');
          // toggle time row visibility
          toggleTimeRow();
        });
        row1.appendChild(btn);
      });
      wrap.appendChild(row1);

      // row 2: duration (hidden for perfection, but preserves space)
      var row2 = document.createElement('div');
      row2.className = 'mode-row';
      timeRow = row2;
      var label2 = document.createElement('div');
      label2.className = 'mode-row-label';
      label2.textContent = 'time';
      row2.appendChild(label2);
      [{v: 30, l: '30s'}, {v: 60, l: '1m'}, {v: 180, l: '3m'}].forEach(function(d) {
        var btn = document.createElement('button');
        btn.className = 'mode-btn' + (d.v === selectedDuration ? ' selected' : '');
        btn.textContent = d.l;
        btn.addEventListener('mousedown', function() {
          selectedDuration = d.v;
          localStorage.setItem('subsequence_duration', d.v);
          row2.querySelectorAll('.mode-btn').forEach(function(b) { b.classList.remove('selected'); });
          btn.classList.add('selected');
        });
        row2.appendChild(btn);
      });
      wrap.appendChild(row2);

      function toggleTimeRow() {
        var els = row2.querySelectorAll('.mode-btn, .mode-row-label');
        els.forEach(function(el) {
          if (selectedMode === 'perfection') el.classList.add('hidden');
          else el.classList.remove('hidden');
        });
      }
      toggleTimeRow();

      // row 3: grid size (select only, no auto-start)
      var row3 = document.createElement('div');
      row3.className = 'mode-row';
      var label3 = document.createElement('div');
      label3.className = 'mode-row-label';
      label3.textContent = 'grid';
      row3.appendChild(label3);
      [3, 4, 6, 9, 12, 24, 48].forEach(function(n) {
        var btn = document.createElement('button');
        btn.className = 'mode-btn' + (n === selectedGrid ? ' selected' : '');
        btn.textContent = n + 'x' + n;
        btn.addEventListener('mousedown', function() {
          selectedGrid = n;
          localStorage.setItem('subsequence_grid', n);
          row3.querySelectorAll('.mode-btn').forEach(function(b) { b.classList.remove('selected'); });
          btn.classList.add('selected');
          // update continue button text
          cont.textContent = 'start — ' + n + 'x' + n;
        });
        row3.appendChild(btn);
      });
      wrap.appendChild(row3);

      // continue/start button
      var cont = document.createElement('button');
      cont.className = 'mode-btn';
      cont.textContent = 'start — ' + selectedGrid + 'x' + selectedGrid;
      cont.style.marginTop = '16px';
      cont.addEventListener('mousedown', function() { startGame(selectedGrid); });
      wrap.appendChild(cont);

      content.appendChild(wrap);
    }

    // settings
    function showSettings() {
      content.innerHTML = '';
      var wrap = document.createElement('div');
      wrap.className = 'settings';

      var section = document.createElement('div');
      section.className = 'settings-section';

      var label = document.createElement('div');
      label.className = 'settings-label';
      label.textContent = 'hit sound';
      section.appendChild(label);

      var list = document.createElement('div');
      list.className = 'sound-list';

      sounds.forEach(function(s) {
        var row = document.createElement('div');
        row.className = 'sound-row' + (s.id === selectedSound ? ' selected' : '');

        var name = document.createElement('div');
        name.className = 'sound-name';
        name.textContent = s.name;
        row.appendChild(name);

        if (s.file) {
          var test = document.createElement('button');
          test.className = 'sound-test';
          test.textContent = 'test';
          test.addEventListener('click', function(e) {
            e.stopPropagation();
            var a = audioCache[s.id];
            if (a) { var c = a.cloneNode(); c.volume = 1; c.play(); }
          });
          row.appendChild(test);
        }

        row.addEventListener('click', function() {
          list.querySelectorAll('.sound-row').forEach(function(r) { r.classList.remove('selected'); });
          row.classList.add('selected');
          saveSoundSetting(s.id);
        });

        list.appendChild(row);
      });

      section.appendChild(list);
      wrap.appendChild(section);
      content.appendChild(wrap);
    }

    // game
    function startGame(size) {
      var mode = selectedMode;
      var duration = mode === 'perfection' ? 0 : selectedDuration;
      gameState = {
        size: size, score: 0, misses: 0, timeLeft: duration,
        targets: new Set(), lastClicked: -1, mode: mode, duration: duration
      };
      content.innerHTML = '';

      // hud
      var hud = document.createElement('div');
      hud.className = 'hud';
      if (mode === 'perfection') {
        hud.innerHTML = '<div class="hud-score">0</div><div class="hud-mode">perfection</div><div class="hud-timer"></div>';
      } else {
        var timeLabel = duration >= 60 ? Math.floor(duration / 60) + ':' + ('0' + (duration % 60)).slice(-2) : duration + 's';
        hud.innerHTML = '<div class="hud-score">0</div><div class="hud-mode">' + mode + '</div><div class="hud-timer">' + timeLabel + '</div>';
      }
      content.appendChild(hud);

      // grid
      var grid = document.createElement('div');
      grid.className = 'grid';
      grid.style.gridTemplateColumns = 'repeat(' + size + ', 1fr)';
      var total = size * size;
      for (var i = 0; i < total; i++) {
        var cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        grid.appendChild(cell);
      }
      content.appendChild(grid);

      // spawn initial targets
      var numTargets = size <= 4 ? 3 : size >= 48 ? 6 : size >= 24 ? 5 : 4;
      for (var t = 0; t < numTargets; t++) spawnTarget(grid);

      // click handler
      for (var c = 0; c < grid.children.length; c++) {
        grid.children[c].addEventListener('mousedown', function(e) {
          e.preventDefault();
          if (this.classList.contains('target')) {
            gameState.score++;
            var clickedIdx = parseInt(this.dataset.index);
            gameState.lastClicked = clickedIdx;
            gameState.targets.delete(clickedIdx);
            this.classList.remove('target');
            spawnTarget(grid);
            hud.querySelector('.hud-score').textContent = gameState.score;
            playHitSound();
          } else {
            gameState.misses++;
            if (gameState.mode === 'perfection') {
              if (gameTimer) { clearInterval(gameTimer); gameTimer = null; }
              endGame();
            }
          }
        });
      }

      // timer (only for time mode)
      if (mode === 'time') {
        gameTimer = setInterval(function() {
          gameState.timeLeft--;
          var tl = gameState.timeLeft;
          var display = tl >= 60 ? Math.floor(tl / 60) + ':' + ('0' + (tl % 60)).slice(-2) : tl + 's';
          hud.querySelector('.hud-timer').textContent = display;
          if (gameState.timeLeft <= 0) {
            clearInterval(gameTimer);
            gameTimer = null;
            endGame();
          }
        }, 1000);
      }
    }

    function spawnTarget(grid) {
      var total = gameState.size * gameState.size;
      var available = [];
      for (var i = 0; i < total; i++) {
        if (!gameState.targets.has(i) && i !== gameState.lastClicked) available.push(i);
      }
      if (available.length === 0) return;
      var idx = available[Math.floor(Math.random() * available.length)];
      gameState.targets.add(idx);
      grid.children[idx].classList.add('target');
    }

    async function saveScore() {
      if (!currentUser) return;
      var total = gameState.score + gameState.misses;
      var accuracy = total > 0 ? Math.round((gameState.score / total) * 100) : 0;
      var { error } = await sb.from('scores').insert({
        user_id: currentUser.id,
        mode: gameState.mode,
        grid_size: gameState.size,
        duration: gameState.duration,
        score: gameState.score,
        accuracy: accuracy,
        misses: gameState.misses
      });
      if (error) console.error('save error:', error);
    }

    async function getTopScores() {
      if (!currentUser) return [];
      var query = sb.from('scores')
        .select('score, accuracy, misses, created_at')
        .eq('user_id', currentUser.id)
        .eq('mode', gameState.mode)
        .eq('grid_size', gameState.size);

      // only filter by duration for time mode
      if (gameState.mode === 'time') {
        query = query.eq('duration', gameState.duration);
      }

      var { data } = await query.order('score', { ascending: false }).limit(10);
      return data || [];
    }

    async function endGame() {
      var total = gameState.score + gameState.misses;
      var accuracy = total > 0 ? Math.round((gameState.score / total) * 100) : 0;
      var currentScore = gameState.score;

      await saveScore();

      var topScores = await getTopScores();
      var isNewBest = topScores.length > 0 && topScores[0].score === currentScore;

      content.innerHTML = '';

      var wrap = document.createElement('div');
      wrap.className = 'results';

      var statsHtml =
        '<div>accuracy <span>' + accuracy + '%</span></div>' +
        '<div>misses <span>' + gameState.misses + '</span></div>' +
        '<div>grid <span>' + gameState.size + 'x' + gameState.size + '</span></div>' +
        '<div>mode <span>' + gameState.mode + '</span></div>';
      if (gameState.mode === 'time') {
        var durLabel = gameState.duration >= 60 ? (gameState.duration / 60) + 'm' : gameState.duration + 's';
        statsHtml += '<div>time <span>' + durLabel + '</span></div>';
      }

      wrap.innerHTML =
        '<div class="results-score">' + currentScore + '</div>' +
        '<div class="results-label">score</div>' +
        (isNewBest ? '<div class="results-new-best">new personal best</div>' : '') +
        '<div class="results-stats">' + statsHtml + '</div>';

      var btn = document.createElement('button');
      btn.className = 'again-btn';
      btn.textContent = 'play again';
      btn.addEventListener('click', showModeSelect);
      wrap.appendChild(btn);

      if (topScores.length > 0) {
        var hist = document.createElement('div');
        hist.className = 'history';
        hist.innerHTML = '<div class="history-title">your top 10</div>';
        topScores.forEach(function(s, i) {
          var d = new Date(s.created_at);
          var dateStr = (d.getMonth() + 1) + '/' + d.getDate();
          var row = document.createElement('div');
          row.className = 'history-row';
          row.innerHTML =
            '<div class="history-rank">' + (i + 1) + '</div>' +
            '<div class="history-score">' + s.score + '</div>' +
            '<div class="history-acc">' + s.accuracy + '%</div>' +
            '<div class="history-date">' + dateStr + '</div>';
          hist.appendChild(row);
        });
        wrap.appendChild(hist);
      }

      content.appendChild(wrap);
    }

    // init
    var hash = window.location.hash.slice(1) || 'grid';
    var el = document.querySelector('nav a[data-tab="' + hash + '"]');
    if (el) {
      document.querySelector('nav a.active').classList.remove('active');
      el.classList.add('active');
    }
    initAuth();
  </script>
</body>
</html>
